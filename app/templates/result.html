<!DOCTYPE html>
<html>
<head>
    <title>Care Plan Result</title>
    <style>
        body { font-family: Arial; max-width: 900px; margin: 50px auto; padding: 20px; }
        .plan { background: #f5f5f5; padding: 20px; white-space: pre-wrap; }
        button { padding: 10px 20px; margin: 10px 5px 0 0; background: #28a745; color: white; border: none; cursor: pointer; }
        button:hover { background: #218838; }
        .back { background: #6c757d; }
        .back:hover { background: #5a6268; }
        
        /* ========== åŠ è½½åŠ¨ç”»æ ·å¼ ========== */
        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 20px;
            background: #e3f2fd;
            border-radius: 8px;
        }
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #90caf9;
            border-top-color: #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ========== çŠ¶æ€å¾½ç« æ ·å¼ ========== */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: bold;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-processing { background: #cce5ff; color: #004085; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-failed { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>Generated Care Plan</h1>
    <p><strong>Patient:</strong> {{ care_plan.patient_first_name }} {{ care_plan.patient_last_name }}</p>
    <p><strong>MRN:</strong> {{ care_plan.patient_mrn }}</p>
    <p><strong>Medication:</strong> {{ care_plan.medication_name }}</p>
    
    <!-- ========== çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ ========== -->
    <p>
        <strong>Status:</strong> 
        <span id="status-badge" class="status-badge status-{{ care_plan.status }}">
            {{ care_plan.status }}
        </span>
    </p>
    
    <!-- ========== å†…å®¹æ˜¾ç¤ºåŒºåŸŸ ========== -->
    <div id="content-area">
        {% if care_plan.status == 'completed' and care_plan.generated_plan %}
            <div class="plan" id="plan-content">{{ care_plan.generated_plan }}</div>
            <a href="/download/{{ care_plan.id }}/" id="download-btn"><button>Download as .txt</button></a>
        {% elif care_plan.status == 'failed' %}
            <p style="color: red;" id="error-msg">Generation failed. Please try again.</p>
        {% else %}
            <!-- ========== å¤„ç†ä¸­ï¼šæ˜¾ç¤ºåŠ è½½åŠ¨ç”» ========== -->
            <div class="loading" id="loading-indicator">
                <div class="spinner"></div>
                <span>Processing your care plan... This may take 10-30 seconds.</span>
            </div>
        {% endif %}
    </div>
    
    <a href="/"><button class="back">Create Another</button></a>

    <!-- ========== Polling JavaScript ä»£ç  ========== -->
    <!-- ä½¿ç”¨ data å±æ€§ä¼ é€’ Django å˜é‡ -->
    <script id="polling-config" 
            data-careplan-id="{{ care_plan.id }}" 
            data-careplan-status="{{ care_plan.status }}">
    </script>
    <script>
    (function() {
        // ======================================
        // Polling è½®è¯¢å®ç°
        // ======================================
        // 
        // å·¥ä½œåŸç†ï¼š
        // 1. æ¯éš” 3 ç§’å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼ŒæŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
        // 2. å¦‚æœçŠ¶æ€æ˜¯ completed æˆ– failedï¼Œåœæ­¢è½®è¯¢
        // 3. æ›´æ–°é¡µé¢å†…å®¹
        
        // -------- 1. è·å–é…ç½®æ•°æ® --------
        const config = document.getElementById('polling-config').dataset;
        const currentStatus = config.careplanStatus;
        const careplanId = config.careplanId;
        
        // -------- 2. æ£€æŸ¥æ˜¯å¦éœ€è¦è½®è¯¢ --------
        // åªæœ‰ pending æˆ– processing çŠ¶æ€æ‰éœ€è¦è½®è¯¢
        if (currentStatus === 'completed' || currentStatus === 'failed') {
            console.log('ğŸ“‹ ä»»åŠ¡å·²ç»“æŸï¼Œæ— éœ€è½®è¯¢');
            return;
        }
        
        console.log('ğŸ”„ å¼€å§‹è½®è¯¢ï¼ŒCarePlan ID:', careplanId);
        
        // -------- 3. è½®è¯¢é—´éš”ï¼ˆæ¯«ç§’ï¼‰--------
        const POLL_INTERVAL = 3000;  // 3 ç§’
        
        // -------- 4. è½®è¯¢å‡½æ•° --------
        function pollStatus() {
            console.log('ğŸ“¡ å‘é€çŠ¶æ€æŸ¥è¯¢è¯·æ±‚...');
            
            fetch(`/api/careplan/${careplanId}/status/`)
                .then(response => response.json())
                .then(data => {
                    console.log('ğŸ“¬ æ”¶åˆ°å“åº”:', data);
                    
                    // æ›´æ–°çŠ¶æ€å¾½ç« 
                    updateStatusBadge(data.status);
                    
                    // æ ¹æ®çŠ¶æ€å¤„ç†
                    if (data.status === 'completed') {
                        // âœ… ä»»åŠ¡å®Œæˆï¼Œæ˜¾ç¤ºç»“æœ
                        showCompletedContent(data.generated_plan);
                        console.log('âœ… ä»»åŠ¡å®Œæˆï¼Œåœæ­¢è½®è¯¢');
                    } else if (data.status === 'failed') {
                        // âŒ ä»»åŠ¡å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯
                        showFailedContent();
                        console.log('âŒ ä»»åŠ¡å¤±è´¥ï¼Œåœæ­¢è½®è¯¢');
                    } else {
                        // â³ ç»§ç»­è½®è¯¢
                        console.log('â³ ä»»åŠ¡å¤„ç†ä¸­ï¼Œ3ç§’åç»§ç»­è½®è¯¢...');
                        setTimeout(pollStatus, POLL_INTERVAL);
                    }
                })
                .catch(error => {
                    console.error('âŒ è½®è¯¢è¯·æ±‚å¤±è´¥:', error);
                    // å‘ç”Ÿé”™è¯¯æ—¶ï¼Œä»ç„¶ç»§ç»­è½®è¯¢
                    setTimeout(pollStatus, POLL_INTERVAL);
                });
        }
        
        // -------- 5. è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°çŠ¶æ€å¾½ç«  --------
        function updateStatusBadge(status) {
            const badge = document.getElementById('status-badge');
            badge.textContent = status;
            badge.className = 'status-badge status-' + status;
        }
        
        // -------- 6. è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºå®Œæˆå†…å®¹ --------
        function showCompletedContent(generatedPlan) {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="plan" id="plan-content">${escapeHtml(generatedPlan)}</div>
                <a href="/download/${careplanId}/" id="download-btn">
                    <button>Download as .txt</button>
                </a>
            `;
        }
        
        // -------- 7. è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºå¤±è´¥å†…å®¹ --------
        function showFailedContent() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <p style="color: red;">Generation failed. Please try again.</p>
            `;
        }
        
        // -------- 8. è¾…åŠ©å‡½æ•°ï¼šHTML è½¬ä¹‰ï¼ˆé˜² XSS æ”»å‡»ï¼‰--------
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // -------- 9. å¼€å§‹è½®è¯¢ --------
        pollStatus();
        
    })();
    </script>
</body>
</html>